  <!-- *****************
  
  Paul Cuddihy, Justin McHugh, Ravi Palla
  Knowledge Discovery Lab
  GE Global Research Niskayuna
  
 
  ***************** -->
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">          
<html>
<head>
    <!-- Include the required JavaScript libraries: -->
    <script type="text/javascript" src='../jquery/jquery-1.9.1.min.js'></script>
    <script type="text/javascript" src='../jquery/jquery-ui-1.10.4.min.js'></script>
    <script type="text/javascript" src='../jquery/jquery.cookie.js'></script>
	<script type="text/javascript" src="../jquery/jquery.jsonp-1.0.4.min.js"></script>
	
	<!-- includes for graph -->
    <script type="text/javascript" src="../js/raphael-min.js"></script>
    <script type="text/javascript" src="../js/dracula_graffle.js"></script>
    <script type="text/javascript" src="../js/dracula_graph.js"></script>
    <script type="text/javascript" src="../js/belmont.js"></script>
    <script type="text/javascript" src="../js/graphGlue.js"></script>

    <!-- Include dynatree: -->
    <link rel='stylesheet' type='text/css' href='../dynatree-1.2.5/skin/ui.dynatree.css'>
    <script src='../dynatree-1.2.5/jquery.dynatree.js' type="text/javascript"></script>
		
	<!-- CSS stuff -->
	<link rel="stylesheet" type="text/css" href="../menu/menu.css" />
	<link rel="stylesheet" type="text/css" href="../css/modaldialog.css" />
	<script type="text/javascript" src="../menu/menu.js"></script>
	
	 <!-- Include local javascript -->
	<script type="text/javascript" src="../js/fusekiserverinterface.js"></script>
	<script type="text/javascript" src='../js/ontologytree.js'></script>
	<script type="text/javascript" src='../js/treeloader.js'></script>	
	<script type="text/javascript" src='../js/ontologyinfo.js'></script>	
	<script type="text/javascript" src='../js/queryserverinterface.js'></script>	
	<script type="text/javascript" src="../js/cookiemanager.js"></script>
	<script type="text/javascript" src="../js/sparqlconnection.js"></script>
	<script type="text/javascript" src="../js/modalloaddialog.js"></script>	
	<script type="text/javascript" src="../js/modaldialog.js"></script>	

	<!-- TODO simple style so the table doesn't look like a high school project (but it still does!) -->
	<style type="text/css">
	.tg  {border-collapse:collapse;border-spacing:0;border-color:#999;}
	.tg td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:0px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#DFF4FF;border-top-width:1px;border-bottom-width:1px;}
	.tg th{font-family:Arial, sans-serif;font-size:14px;font-weight:bold;padding:10px 5px;border-style:solid;border-width:0px;overflow:hidden;word-break:normal;border-color:#999;color:#000000;background-color:#9CDEFF;border-top-width:1px;border-bottom-width:1px;}
	.tg .tg-e3zv{font-weight:bold}
	.tgembed {width:100%;}
	</style>
	
    <script type="text/javascript">
    var helpAboutMessage = "SparqlGraph 0.9\n\nPaul Cuddihy, Justin McHugh, Ravi Palla\nKnowledge Discovery Lab\nGE Research, Niskayuna";
   
    var oTree = null;
    var oInfo = null;
    var qsInterface = null;
    var qsInterfaceData = null;
    
    var serverURL = null;
    var ksURL = null;
    var source = null;
    var domain = null;
    
    // drag stuff
    var draglabel = "hi";
    
    var mLoadDialog;
    
    // graph 
     
    $(function(){
    	// create the modal dialogue 
    	
    	mLoadDialog = new ModalLoadDialog(document, "mLoadDialog");
    	mDialogue = new ModalDialog(document, "mDialogue");
    	setModalDialogue(mDialogue);
    
        // Attach the dynatree widget to an existing <div id="tree"> element
        // and pass the tree options as an argument to the dynatree() function:
        $("#tree").dynatree({
            onActivate: function(node) {
                // A DynaTreeNode object is passed to the activation handler
                // Note: we also get this event, if persistence is on, and the page is reloaded.
                console.log("You activated " + node.data.title);
            },
            onDblClick: function(node) {
                // A DynaTreeNode object is passed to the activation handler
                // Note: we also get this event, if persistence is on, and the page is reloaded.
                console.log("You double-clicked " + node.data.title);
            },
    		
            dnd: {
            	onDragStart: function(node) {
                /** This function MUST be defined to enable dragging for the tree.
                 *  Return false to cancel dragging of node.
                 */
                	logMsg("tree.onDragStart(%o)", node);
                	console.log("dragging " + node.data.key);
                	draglabel = node.data.key;
                	return true;
            	},
            	onDragStop: function(node) {
        			logMsg("tree.onDragStop(%o)", node);
        			console.log("dragging " + node.data.key + " stopped.");
      			}
            	
        	},	
            
            persist: true}
           
            
        );
        oTree = new OntologyTree($("#tree").dynatree("getTree"));
    });
    
    	
    	// CATERHAM queryserver
		//serverURL = 'http://etna3.crd.ge.com:8080/queryserver';
		//ksURL = 'http://etna3.crd.ge.com:8080/sadlserver/SadlService';
		//source = "Caterham";
		//domain = "caterham.ge.com";
		
		// ontology comes from here
		// serverURL = 'http://kaas-dev.crd.ge.com:8080/queryserver';
		// ksURL = 'http://kaas-dev.research.ge.com:8080/sadlserver/SadlService';
		// source = "Caterham";
		// domain = "http://caterham.ge.com";

		
	    
	   //   DAKS Fuseki
	   // 	serverURL = "http://etna3.crd.ge.com:3030";
	   // 	dataset = "daks";
	   // 	domain = "http://research.ge.com/cmr";
    
    doLoad = function() {
    	mLoadDialog.loadDialog(doLoadDialogCallback);
    }
    
    doLoadDialogCallback = function(connProfile) {
    	// Callback from the load dialog
    	
    	// Get connection info from dialog return value
    	qsInterfaceData = connProfile.getDataInterface();
    	qsInterface = connProfile.getOntologyInterface();
    	domain = connProfile.getDomain();
    	
    	// Clean out existing memory
    	oTree.removeAll();
    	oInfo = new OntologyInfo();
    	clearQuery();
    	clearResults();
    	
    	// Need to initialize this object intelligently:  some server address
    	var sparql = oInfo.getSuperSubClassQuery(domain);
    	setStatus("Loading ontology (1/3: sub-classes)");
    	qsInterface.executeAndParse(sparql, doLoad1);
    }
    
    doLoad1 = function (qsResult) {
    	// if loading is still successful, load classes, run topLevelClass query, callback: doLoad2()
    	
    	if (!qsResult.isSuccess()) {
    		alert("doLoad1() Super-subclass query:\n " + qsResult.getStatusMessage());
    		setStatus("");
    	} else {
    		oInfo.loadSuperSubClasses(qsResult);
    		    	
    		var sparql = oInfo.getTopLevelClassQuery(domain);
    		setStatus("Loading ontology (2/3: top-level classes)");
    		qsInterface.executeAndParse(sparql, doLoad2);
    	}
    }
    
    doLoad2 = function (qsResult) {
    	// if loading is still successful, load classes, run loadProperties query, callback: doLoad2()
    	
    	if (!qsResult.isSuccess()) {
    		alert("doLoad2() Top-level class query:\n " + qsResult.getStatusMessage());
    		setStatus("");
    	} else {
    		oInfo.loadTopLevelClasses(qsResult);
    		    	
    		var sparql = oInfo.getLoadPropertiesQuery(domain);
    		setStatus("Loading ontology (3/3: properties)");
    		qsInterface.executeAndParse(sparql, doLoad3);
    	}
    }
    
    doLoad3 = function  (qsResult) {
    	// last in callback chain.  Load properties into oInfo and load oInfo into oTree
    	if (!qsResult.isSuccess()) {
    		alert("doLoad3() properties query:\n " + qsResult.getStatusMessage());
   
    	} else {
    		oInfo.loadProperties(qsResult);
    		
    		// now load oInfo into oTree
    		oTree.addOntInfo(oInfo);
    		
    	}
    	setStatus("");
    }
    
    doUnload = function () {
    	oTree.removeAll();
    	oInfo = null;
    	clearQuery();
 		clearResults();
    }
    
    doSearch = function() {
    	oTree.find($("#search").val());
    }
    
     
    setStatus = function(msg) {
    	document.getElementById("status").innerHTML= "<font color='red'>" + msg + "</font>";
    };
    
    buildQuery = function() {
        var qElem = document.getElementById("queryText");
        document.getElementById('queryText').value = nodeGroup.generateSparql();
        document.getElementById("results").innerHTML= "";
        
    };
    runQuery = function (){
    	var query = document.getElementById("queryText").value;
    	var qElem = document.getElementById("results").innerHTML = "answer here";
   
		clearResults();

		if (query.length < 1) {
			alert("Can't run empty query.  Use 'build' button first.");
			
		} else {
			// HTML: tell user query is running
			setStatus("running query...");
			 
			qsInterfaceData.executeAndParse(query, runQueryCallback);
		}
	};
		
	// The query callback  
	runQueryCallback = function(qsresult) {
	
		// HTML: tell user query is done
		setStatus("");
		
		if (qsresult.isSuccess()) {
			
			// QueryServerResult will turn itsself into an HTML table on command
			var nsFlag = document.getElementById("namespace").checked? QueryServerResult.prototype.NAMESPACE_YES: QueryServerResult.prototype.NAMESPACE_NO;
			var resultTableHTML = qsresult.getResultsHTMLTable("class='tg'", nsFlag);
			document.getElementById("results").innerHTML= resultTableHTML;
		}
		else {
			alert(qsresult.getStatusMessage());
		}
	};
	
	// Clear functions
	// Each one clears other things that depend upon it.
	clearResults = function() {
		document.getElementById("results").innerHTML = "";
	}
    
	clearQuery = function() {
	 	document.getElementById('queryText').value = "";
	 	clearResults();
	}
	
    clearGraph = function () {
    	nodeGroup.clear();
    	clearQuery();
    }
    
    clearTree = function() {
    	oTree.removeAll();
    	clearGraph();
    }
    
    </script>
    
</head>
<body>
    <!--  ------------   MENU ----------------  -->
	<div id="menuwrapper" style="width:100%">
		<ul id="menubar" >
			<li onmouseover="menu(this)" onmouseout="menuOut(this)"><a href="#" >File</a>
				<ul>
					<li><a href="javascript:doLoad();">Load</a></li>
				</ul>
			</li>
			<li onmouseover="menu(this)" onmouseout="menuOut(this)"><a href="#" >Tree</a>
				<ul>
					<li><a href="javascript:oTree.expandAll();">Expand</a></li>
					<li><a href="javascript:oTree.collapseAll();">Collapse</a></li>
					<li><a href="javascript:clearTree();">Clear</a></li>
					
				</ul>
			</li>
			<li onmouseover="menu(this)" onmouseout="menuOut(this)"><a href="#" >Graph</a>
				<ul>
					<li><a href="javascript:clearGraph();">Clear</a></li>
					
				</ul>
			</li>
			<li onmouseover="menu(this)" onmouseout="menuOut(this)"><a href="#" >Help   </a>
				<ul>
					<li><a href="javascript:testPath();">Test Path</a></li>
					<li><a href="javascript:alert(helpAboutMessage);">About</a></li>
				</ul>
			</li>
		</ul>
	</div>
	<br></br>
	
	

    
     <!--  ------------   PAGE ----------------  -->
    <table style="width:100%;">
	<tr><td>
	    <form action="javascript:doSearch()">
		    <input type="text" id="search" align="left" autocomplete="off"/>
		    <button type="submit">search</button>
	    </form>
    </td></tr>
    <tr><td>
	    <div id="tree" style="height:500px; width:20%; overflow-y:hidden;float:left;border:1px solid black" class="ui-corner-all ui-widget-content" > </div>
		<div id="canvasWrapper" style="height:500px; width:75%;overflow:auto;border:1px solid black">
			<div id="canvas" style="height:700px; width:1000px; overflow:hidden;float:left;border:1px solid gray" class="ui-widget-content"></div>
		</div>
	</td></tr>
	<tr><td>
		<div id="status"></div>
	</tr></td>
    
	<tr><td>
		<div id="query" style="width=90%;border:1px solid white">
		   <table width="100%">
		   		<tr><td>
			   		Query: 
			   		<button type="build" onclick="javascript:buildQuery()">build</button>
			   		<button type="run" onclick="javascript:runQuery()">run</button>
			   		<INPUT type="checkbox" id="namespace" checked> Show namespaces
		   		</tr></td>
		   		<tr><td>
			   		<textarea NAME="Query" id="queryText" ROWS=15 COLS=120 autocomplete="off">
			   		</textarea>
		   		</tr></td>
		   		<tr><td>
			   		<div id="resultsdiv" style="width:100%;border:1px solid white">
				   		Results:
				   		<p id="results"></p>
			   		</div>
		   		</tr></td>
		   		<tr>
	       </table>
		 <div>
	 </td></tr>
	 </table>
	
    <script type="text/javascript">
	$("#canvas").droppable({
    hoverClass: "drophover",
    addClasses: true,
    over: function(event, ui) {
      logMsg("droppable.over, %o, %o", event, ui);
    },
    drop: function(event, ui) {
      var source = ui.helper.data("dtSourceNode") || ui.draggable;
      // alert("dropped " + draglabel);
      // add the node to the canvas
   	  var tsk = oInfo.containsClass(draglabel);
   	  //alert("was the object " + draglabel + " in the list?" + tsk);

	  if ( tsk ){
	  	// the class was found. let's use it.
	  	var classToUse = oInfo.getClass(draglabel);
	  	// show a list of properties...
	  	var newnode = returnBelmontSemanticNode(classToUse, oInfo, nodeGroup);
	  	console.log("current node count is " +  nodeGroup.getNodeCount());
	  	
	  	if(!nodeGroup.alreadyExists(newnode)){
	  		// do not add an existing node
	  		var nodelist = nodeGroup.getArrayOfURINames();
	  		var paths = oInfo.findAllPaths(newnode.getURIName(), nodelist, domain);
	  		var p = [];
	  		
	  		// if paths came back, make a list of just the first one in old format
	  		if (paths && paths.length > 0) {
	  			 p = [ paths[0].asList() ] ;
	  		} 
	  		
	  		nodeGroup.addNode(newnode, p, oInfo);
	  		nodeGroup.drawNodes();
	  		
	  		
	  	}
	  	else{
	  		//	alert("node already exists");
	  		}
	  }
	  else{
	  	// not found
	  	alert("tried a property!");
	  	
	  }
    }
  });
  
   var nodeGroup = new SemanticNodeGroup(1000, 700);
 
  </script>

<div id="modaldialog"></div>  
</body>
</html>